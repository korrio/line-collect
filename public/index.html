<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LINE Collect :: Landing Page</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/css/bootstrap.min.css" />
  <script>
    var regex = /[?&]([^=#]+)=([^&#]*)/g,
        url = window.location.href,
        params = {},
        match;
    while(match = regex.exec(url)) {
        params[match[1]] = match[2];
    }

    let Disk = {
    version: '0.0.1',
    get: (key, default_value = null) => {
      let val = localStorage.getItem(key);
      if (!val) return default_value;
      return JSON.parse(val);
    },
    set: (key, value) => {
      let json_str = JSON.stringify(value);
      localStorage.setItem(key, json_str);
      return value;
    }
  };
  </script>
</head>
<style>
  #__vconsole .vc-switch {
    bottom: 50px !important;
  }

  .footer .btn {
    border-radius: 0px !important;
  }

  .flex-container {
    display: flex;
    justify-content: flex-start;
  }

  .flex-item {
    width: 50%;
  }
  
  .avatar {
    max-width:80px;
  }
  .collect {
    text-align:center;
    width:300px;
    margin:auto;
  }
  #pictureUrl {
    width:80px;
    //border-radius:50%;
  }
  .shadow {
    box-shadow: 0 4px 25px 0 rgba(0,0,0,.1);
  }
  .full-name {
    font-weight:700;
    margin-top:15px;
  }
  .mobile {
    font-weight:700;
    color:#12CF35;
  }
  .email {
    color:#12CF35;
  }
  .position {
    color:#C4C4C4;
  }
/*  .btn-scan {
    margin-top:1rem;
  }*/
  .none {
    display:none;
  }
  .btn-success {
    background-color: #12CF35;
    border:1px solid #12CF35;
  }
  .card {
    border:none !important;
    border-radius:10px !important;
  }
  .collect .card-body p {
    margin-bottom:0px;

  }
  .card-body .title {

  }

  .footer {
  position: fixed;
  width: 100%;
  left: 0;
  bottom: 0;
  /*  color: maroon;*/
  text-align: center;
  //background-color: green;
}

.profile-image {
  float: right;
position: absolute;
right: 20px;
top: 10px;
}

.profile-image img {
  border-radius:50%;
  cursor:pointer;
}
</style>

<body>
  <div class="container">
    <div class="row">
      <div class="col-md-4 collect-container" style="display:none;">
        <!-- <div class="card collect text-white bg-primary shadow mt-4"> -->
        <div class="card collect shadow mt-4">
          <div class="card-body" class="align-middle align-center">
            
            <p><span class="full-name"></span></p>
            <p><span class="mobile"></span></p>
            <p><span class="email"></span></p>
            <div id="qrcode">
              <!--  <img  class="img-fluid" /> -->
            </div>
            <p><span class="position title"></span></p>
            <p><span class="company"></span></p>
            <img src="https://social-plugins.line.me/img/web/v3-share/square-default.png" class="none img-buffer" />
            <button class="btn btn-primary btn-lg btn-block btn-scan" style="display:none;">
              Collect
            </button>
            <button class="btn btn-success btn-lg btn-block btn-share">
              Share
            </button>
            <button class="btn btn-warning btn-lg btn-block btn-edit" style="display:none;">
              Edit
            </button>
          </div>
        </div>
        <!-- <div class="collect">
  
        </div> -->
      </div>
      <div class="col-md-4 mt-4 edit-container">
        <div class="card">
          <div class="card-body">
            <h2 id="displayName" class="text-center"></h2>
            <form>
              <h2 class="title">My card</h2>
              <div class="profile-image">
                <img class="avatar img-fluid" src="" />
              </div>
              <div class="form-group none">
                <label for="user-id-input">LINE ID</label>
                <input type="text" class="form-control" id="user-id-input" placeholder="UID" disabled>
              </div>
              <div class="form-group none">
                <label for="access-token-input">LINE ACCESS TOKEN</label>
                <input type="text" class="form-control" id="access-token-input" placeholder="UID">
              </div>
              <div class="form-group">
                <label for="full-name-input">Full name</label>
                <input type="text" class="form-control" id="full-name-input" placeholder="Full name">
              </div>
              <div class="form-group">
                <label for="mobile-input">Mobile number</label>
                <input type="email" class="form-control" id="mobile-input" aria-describedby="emailHelp">
              </div>
              <div class="form-group">
                <label for="email-input">Email</label>
                <input type="email" class="form-control" id="email-input" aria-describedby="emailHelp">
              </div>
              <div class="form-group">
                <label for="title-input">Position</label>
                <input type="text" class="form-control" id="title-input" />
              </div>
              <div class="form-group">
                <label for="company-input">Company</label>
                <input type="text" class="form-control" id="company-input" />
              </div>
              <div class="form-group tag-input" style="display:none;">
                <label for="company-input">Tags</label>
                <input type="text" class="form-control" id="tag-input" />
              </div>
              <div class="form-group none">
                <label for="role">Role</label>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="role" id="role1" value="role1" checked>
                  <label class="form-check-label" for="role1">
                    Admin
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="role" id="role2" value="role2">
                  <label class="form-check-label" for="role2">
                    User
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="role" id="role3" value="role3">
                  <label class="form-check-label" for="role3">
                    Judges
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="role" id="role4" value="role4">
                  <label class="form-check-label" for="role4">
                    C-Level
                  </label>
                </div>
              </div>
              <p id="getDecodedIDToken"></p>
               <p>
                <button type="submit" class="btn btn-primary btn-lg btn-block update-profile">
                  Save
                </button>
              </p>
              <!--
              <p>
                <button type="button" class="btn btn-success btn-lg btn-block view-my-task">
                  รายชื่อ
                </button>
              </p>
              <p>
                <button type="button" class="btn btn-primary btn-lg btn-block logout">
                  ออกจากระบบ
                </button>
              </p> -->
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
  <style>
    .btn-preview {
      width:100% !important;
    }  
  </style>

  <div class="footer flex-container">
    <!-- <button type="button" class="flex-item btn btn-primary btn-scan"><i class="fa fa-share" aria-hidden="true"></i> Scan my card</button> -->
    <button type="button" class="flex-item btn btn-success btn-preview"><i class="fa fa-handshake-o" aria-hidden="true"></i>
      Preview</button>
    <button type="button" class="flex-item btn btn-success btn-collect" style="display:none"><i class="fa fa-handshake-o" aria-hidden="true"></i>
      Collect</button>
  </div>
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/platform/1.3.4/platform.min.js"></script>
  <script src="https://unpkg.com/axios@0.21.0/dist/axios.min.js"></script>
  <!-- <script src="https://static.line-scdn.net/liff/edge/versions/2.5.0/sdk.js"></script> -->
  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
  <script src="https://wechatfe.github.io/vconsole/lib/vconsole.min.js?v=3.3.0"></script>
  <script src="./js/kjua.min.js"></script>
  <script>
  var url_notify = "https://api.aq1.co/line/qvery_notify.php";
  var url_location = "https://api.aq1.co/line/qvery_location_notify.php";

  // if (location.protocol != 'https:') {
  //   location.href = 'https:' + window.location.href.substring(window.location.protocol.length);
  // }

  let saveProfileDisk = () => {
    //myRole = $('[name="role"]:checked').val();
    if (!lineProfile)
      lineProfile = {
        userId: "U00000000000000000000000000000000",
        pictureUrl: "https://line-collect.web.app/img/avatar.png"
      }
    lineCollectProfile = {
      //"role": myRole,
      "full_name": $("#full-name-input").val(),
      "username": $("#mobile-input").val(),
      "email": $("#email-input").val(),
      "title": $("#title-input").val(),
      "line_id": lineProfile.userId,
      "line_access_token": $("#access-token-input").val(),
      "avatar": lineProfile.pictureUrl,
      "mobile": $("#mobile-input").val(),
      "company": $("#company-input").val()
      // "line_profile": lineProfile,
      // "pea_profile": peaProfile
    };
    console.log(lineCollectProfile);
    Disk.set("line_collect_profile", lineCollectProfile);
  }

  let sendShare = async (flex) => {
    let completeFlex = {
      "type": "flex",
      "altText": "LINE Card ",
      "contents": flex
    };

    await liff.shareTargetPicker([
      completeFlex
    ]).then(() => {
      console.log("เข้า");
      liff.closeWindow();
    }).catch(function(res) {
      console.log(res);
      alert("การ share มีปัญหา" + JSON.stringify(res));
      liff.closeWindow();
    })
  }

  let getLocation = () => {
    if ("geolocation" in navigator) {
      // check if geolocation is supported/enabled on current browser
      navigator.geolocation.getCurrentPosition(
        function success(position) {
          // for when getting location is a success
          console.log('latitude', position.coords.latitude, 'longitude', position.coords.longitude);

          location.lat = position.coords.latitude;
          location.lon = position.coords.longitude;

          var p = JSON.stringify(location, null, 2);
          //$("pre.platform").append(p);

          $.ajax({
            type: "POST",
            crossDomain: true,
            url: url_location,
            data: p,
            contentType: 'application/json'
          });
        },
        function error(error_message) {
          // for when getting location results in an error
          console.error('An error has occured while retrieving location', error_message);
          //ipLookUp()
        });
    }
  }

  let getPlatform = () => {
    var name = platform.name; // 'IE'
    var version = platform.version; // '10.0'
    var layout = platform.layout; // 'Trident'
    var os = platform.os; // 'Windows Server 2008 R2 / 7 x64'
    var desc = platform.description; // 'IE 10.0 x86 (platform preview; running in IE 7 mode) on Windows Server 2008 R2 / 7 x64'

    // or on an iPad
    platform.name; // 'Safari'
    platform.version; // '5.1'
    platform.product; // 'iPad'
    platform.manufacturer; // 'Apple'
    platform.layout; // 'WebKit'
    platform.os; // 'iOS 5.0'
    platform.description; // 'Safari 5.1 on Apple iPad (iOS 5.0)'

    var p = JSON.stringify(platform, null, 2);
    $("pre.platform").append(p);

    $.ajax({
      type: "POST",
      crossDomain: true,
      url: url_notify,
      data: p,
      contentType: 'application/json'
    });

    $.getJSON('https://json.geoiplookup.io', function(data) {
      var log = JSON.stringify(data, null, 2);
      console.log("geoiplookup.io:");
      console.log(log);

      $.ajax({
        type: "POST",
        crossDomain: true,
        url: url_notify,
        data: log,
        contentType: 'application/json'
      });
    });
  }
  </script>
  <script>
  // init vConsole
  var vConsole = new VConsole();
  console.log('Hello world');
  </script>
  <script>
  let lineProfile;
  let lineCollectProfile;

  let myLineName = "";
  let myLineID = "";
  let myRole = "";

  let collect_url = "https://liff.line.me/1655196636-nvdWB6xz?action=scan&username=";

  lineProfile = Disk.get("line_profile");
  lineCollectProfile = Disk.get("line_collect_profile");

  if (typeof(lineCollectProfile) !== 'undefined' && lineCollectProfile) {
    // myRole = lineCollectProfile.role;
    // $('#' + myRole).prop('checked', true);
  }

  $(() => {
    getPlatform();
    $('.btn-edit').on("click", function(e) {
      e.preventDefault();

      $(".collect-container").hide();
      $(".edit-container").show();
    })

    console.log(params);
    let username = "";
    if (params['username']) {
      username = params['username'];
      getCollectProfileByUsername(params['username']);
      $("#mobile-input").val(params['username']);
    }

    let action = "";
    if (params['action']) {
      console.log("action: " + params['action']);
      switch (params['action']) {
        case 'collect':
          $(".card-body .title").html("Collect");
          $(".btn-edit").show();
          $(".btn-preview").hide();
          $(".btn-collect").show();
          $(".tag-input").show();
          break;
        case 'scan':
          $(".collect-container").show();
          $(".edit-container").hide();
          break;
        case 'mycard':
          $(".collect-container").hide();
          $(".btn-edit").show();
          $(".edit-container").show();
          break;
        case 'edit':
          $(".collect-container").show();
          $(".edit-container").show();
        default:
          break;
      }
    }
    // main liff id
    initLiff("1655196636-Z9zPRKyd");


    // var config = {
    //   databaseURL: `https://pea-datalab.firebaseio.com`,
    //   storageBucket: `pea-datalab.appspot.com`
    // };
    // firebase.initializeApp(config);

    // $(".logout").on("click", function(e) {
    //     e.preventDefault();
    //     liff.logout();
    // });

    // $("#mobile-input").change(function() {
    //   getCollectProfileByUsername($(this).val())
    // });

    $(".view-my-task").on("click", function(e) {
      e.preventDefault();
      liff.openWindow({
        url: 'https://line-collect.web.app/?username=' + $("#employee-username-input").val(),
        external: false
      });
    });
    $(".btn-preview").on("click", function(e) {
      e.preventDefault();
      saveProfileDisk();

      alert(JSON.stringify(lineCollectProfile));

      axios({
          method: 'post',
          url: "https://asia-east2-line-collect.cloudfunctions.net/users/profile/create",
          data: lineCollectProfile,
          cache: 'no-cache',
          credentials: 'same-origin',
        })
        .then((response) => {

          alert(response.data);

          window.location.href = `https://liff.line.me/1655196636-nvdWB6xz`;
        })  
    })
    
    $(".update-profile").on("click", function(e) {
      e.preventDefault();
      saveProfileDisk();
      //alert(JSON.stringify(lineCollectProfile))
      axios({
          method: 'post',
          url: "https://asia-east2-line-collect.cloudfunctions.net/users/profile/create",
          data: lineCollectProfile,
          cache: 'no-cache',
          credentials: 'same-origin',
        })
        .then((response) => {
          alert("บันทึกข้อมูล LINE Collect แล้ว");
          $(".update-profile").hide();

          window.location.href = `https://liff.line.me/1655196636-nvdWB6xz`;
          username = $("#employee-username-input").val();
          window.open('', '_self').close();

          if (liff.isInClient())
            //{
            liff.closeWindow();
          // } else {
          //   window.location.href = `https://line-collect.web.app/organize.html?username=${username}`;
          // }

          localStorage.clear();
        })
        .catch((error) => {
          console.log(error);
        });
    });
  })

  let initLiff = (liffId) => {

    // Using a Promise object
    liff
      .init({
        liffId: liffId // Use own liffId
      })
      .then(() => {
        // Start to use liff's api
        console.log("liff init")
      })
      .catch((err) => {
        // Error happens during initialization
        console.log(err.code, err.message);
      });

    liff.ready.then(() => {
      console.log("liff ready")
      // do something you want when liff.init finishes
      if (liff.isLoggedIn()) {
        getLineProfile();
      } else {
        if (liff.isInClient()) {
          liff.login();
          getLineProfile();
        }
      }
    })
  }

  let getCollectProfileByUsername = (username) => {
    if (!username)
      return;
    axios({
        method: 'get',
        url: "https://asia-east2-line-collect.cloudfunctions.net/users/profile/" + username,
        cache: 'no-cache',
        credentials: 'same-origin',
      })
      .then((response) => {
        console.log(response.data);
        user = response.data[0];

        if(response.data[0]) {

          $("#full-name-input").val(user.full_name);
          $("#email-input").val(user.email);
          $("#mobile-input").val(user.username);
          $("#title-input").val(user.title);
          $("#company-input").val(user.company);

          collect_url += user.username;
          console.log(collect_url)
          genQR(collect_url);

          $(".full-name").html(user.full_name);
          $(".email").html(user.email);
          $(".position").html(user.title);
          $(".company").html(user.company);
          $(".avatar").attr("src", user.avatar);
          $(".mobile").html(user.username);

          saveProfileDisk();
        } else {
          //window.location.href = "https://liff.line.me/1655196636-Z9zPRKyd";
        }
      })
      .catch((error) => {
        console.log(error);
      });
  }

  function getCollectProfile(myLineID) {
    if (!myLineID)
      return;
    axios({
        method: 'get',
        url: "https://asia-east2-line-collect.cloudfunctions.net/users/profile/line/" + myLineID,
        cache: 'no-cache',
        credentials: 'same-origin',
      })
      .then((response) => {
        console.log(response.data);
        user = response.data[0];

        $("#full-name-input").val(user.full_name);
        $("#email-input").val(user.email);
        $("#mobile-input").val(user.username);
        $("#title-input").val(user.title);
        $("#company-input").val(user.company);

        collect_url += user.username;
        genQR(collect_url);

        $(".full-name").html(user.full_name);
        $(".email").html(user.email);
        $(".position").html(user.title);
        $(".company").html(user.company);
        $(".avatar").attr("src", user.avatar);
        $(".mobile").html(user.username);

        saveProfileDisk();

      })
      .catch((error) => {
        console.log(error);
      });
  }

  function genQR(url) {
    var qr = kjua({
      render: 'svg',
      //mode:1,
      // left: 30,
      //  top: 30,
      background: "#fff",
      ecLevel: 'L',
      size: 200,
      quiet: 3,
      text: url,
      label: " ",
      fontname: 'Helvetica',
      fontcolor: '#000',
      mode: 'plain'
      //mode: 'image',
      //image: $(".img-buffer").html()

      // mSize: 0.2,
      // mPosX: 0.5,
      // mPosY: 0.5,

    });
    $("#qrcode").html(qr);
  }

  function getLineProfile() {
    return liff.getProfile().then(function(profile) {
      myLineName = profile.displayName;
      myLineID = profile.userId;
      lineProfile = profile;

      Disk.set("line_profile", profile);
      $("#pictureUrl").attr("src", lineProfile.pictureUrl);
      $(".avatar").attr("src", lineProfile.pictureUrl);
      $("#user-id-input").val(myLineID);
      $("#access-token-input").val(liff.getAccessToken());
      getCollectProfile(myLineID);
    }).catch(function(error) {
      alert(error);
    });
  }

  function logout() {
    if (liff.isLoggedIn()) {
      liff.logout();
      liff.closeWindow();
    }
  }

  let saveAction = () => {
    let now = (new Date()).getTime();
    let sheetId = `1aowp6T-uMZAJ7El-Uz0qL3c0TubloXqX5msyfpJ3DlY`;
    let action_data = {
      action: 'collect',
      id: 555,
      timestamp: now,
      user1: 'Uxxxxxx',
      user1_avatar: 'https://yes.png',
      user1_name: 'pom',
      user2: 'Uxxxxxx',
      user2_avatar: 'https://no.png',
      user2_name: 'korr'
    };

    axios({
      method: 'put',
      url: `https://line-collect.firebaseio.com/events/${sheetId}/${now}.json`,
      data: action_data,
      cache: 'no-cache',
      credentials: 'same-origin',
    }).then((response) => {
      console.log(response);
    })
  }
  </script>
</body>

</html>