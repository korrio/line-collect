<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LINE Collect :: Landing Page</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/css/bootstrap.min.css" />
  <script>
    var regex = /[?&]([^=#]+)=([^&#]*)/g,
        url = window.location.href,
        params = {},
        match;
    while(match = regex.exec(url)) {
        params[match[1]] = match[2];
    }
  </script>
</head>
<style>
  .avatar {
    max-width:80px;
  }
  .collect {
    text-align:center;
    width:300px;
    margin:auto;
  }
  #pictureUrl {
    width:80px;
    //border-radius:50%;
  }
  .shadow {
    box-shadow: 0 4px 25px 0 rgba(0,0,0,.1);
  }
  .full-name {
    font-weight:700;
    margin-top:15px;
  }
  .mobile {
    font-weight:700;
    color:#12CF35;
  }
  .email {
    color:#12CF35;
  }
  .position {
    color:#C4C4C4;
  }
  .none {
    display:none;
  }
  .btn-success {
    background-color: #12CF35;
    border:1px solid #12CF35;
  }
  .card {
    border:none !important;
    border-radius:10px !important;
  }
</style>

<body>
  <div class="container">
    <div class="row">
      <div class="col-md-4">
        <!-- <div class="card collect text-white bg-primary shadow mt-4"> -->
        <div class="card collect shadow mt-4">
          <div class="card-body" class="align-middle align-center">
            <div class="profile-image mx-auto">
              <img class="avatar  img-fluid" src="" />
            </div>
            <span class="full-name">Thananon Ngoenthaworn</span>
            <span class="mobile">0826539264</span>
            <p><span class="email">korr@aq1.co</span></p>
            <div id="qrcode">
              <!--  <img  class="img-fluid" /> -->
            </div>
            <span class="position">Full stack developer</span>
            <p><span class="company">AQUARIO Co.,Ltd.</span></p>
            <img src="https://social-plugins.line.me/img/web/v3-share/square-default.png" class="none img-buffer" />
            <button class="btn btn-primary btn-lg btn-block btn-scan">
              Collect
            </button>
            <button class="btn btn-success btn-lg btn-block update-profile">
              Save
            </button>
          </div>
        </div>
        <!-- <div class="collect">
  
        </div> -->
      </div>
      <div class="col-md-4 mt-4">
        <div class="card">
          <div class="card-body">
            <h2 id="displayName" class="text-center"></h2>
            <form>
              <!-- <h2>อัพเดทข้อมูลส่วนตัว</h2> -->
              <div class="form-group">
                <label for="user-id-input">LINE ID</label>
                <input type="text" class="form-control" id="user-id-input" placeholder="UID" disabled>
              </div>
              <div class="form-group">
                <label for="access-token-input">LINE ACCESS TOKEN</label>
                <input type="text" class="form-control" id="access-token-input" placeholder="UID">
              </div>
              <div class="form-group">
                <label for="full-name-input">Full name</label>
                <input type="text" class="form-control" id="full-name-input" placeholder="First Name">
              </div>
              <div class="form-group">
                <label for="mobile-input">Mobile number</label>
                <input type="email" class="form-control" id="mobile-input" aria-describedby="emailHelp">
              </div>
              <div class="form-group">
                <label for="email-input">Email</label>
                <input type="email" class="form-control" id="email-input" aria-describedby="emailHelp">
              </div>
              <div class="form-group">
                <label for="title-input">Position</label>
                <input type="text" class="form-control" id="title-input" />
              </div>
              <div class="form-group">
                <label for="company-input">Company</label>
                <input type="text" class="form-control" id="company-input" />
              </div>
              <div class="form-group">
                <label for="role">Role</label>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="role" id="role1" value="role1" checked>
                  <label class="form-check-label" for="role1">
                    Admin
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="role" id="role2" value="role2">
                  <label class="form-check-label" for="role2">
                    User
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="role" id="role3" value="role3">
                  <label class="form-check-label" for="role3">
                    Judges
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="role" id="role4" value="role4">
                  <label class="form-check-label" for="role4">
                    C-Level
                  </label>
                </div>
              </div>
              <p id="getDecodedIDToken"></p>
              <p>
                <button type="submit" class="btn btn-primary btn-lg btn-block update-profile">
                  อัพเดทข้อมูล
                </button>
              </p>
              <p>
                <button type="button" class="btn btn-success btn-lg btn-block view-my-task">
                  รายชื่อ
                </button>
              </p>
              <p>
                <button type="button" class="btn btn-primary btn-lg btn-block logout">
                  ออกจากระบบ
                </button>
              </p>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://static.line-scdn.net/liff/edge/versions/2.5.0/sdk.js"></script>
  <script src="https://wechatfe.github.io/vconsole/lib/vconsole.min.js?v=3.3.0"></script>
  <script src="./js/kjua.min.js"></script>
  <script>
  // init vConsole
  var vConsole = new VConsole();
  console.log('Hello world');
  </script>
  <script>
  let Disk = {

    version: '0.0.1',

    get: (key, default_value = null) => {
      let val = localStorage.getItem(key);
      if (!val) return default_value;
      return JSON.parse(val);
    },

    set: (key, value) => {
      let json_str = JSON.stringify(value);
      localStorage.setItem(key, json_str);
      return value;
    }

  };

  let lineProfile;
  let lineCollectProfile;

  let myLineName = "";
  let myLineID = "";
  let myRole = "";

  let collect_url = "https://liff.line.me/1655196636-nvdWB6xz?username=";

  lineProfile = Disk.get("line_profile");
  lineCollectProfile = Disk.get("line_collect_profile");

  if (typeof(lineCollectProfile) !== 'undefined' && lineCollectProfile) {
    myRole = lineCollectProfile.role;
    $('#' + myRole).prop('checked', true);
  }

  $(() => {
    $(".btn-scan").on("click",function(e){
      e.preventDefault();

      window.location.href = "https://line.me/R/nv/QRCodeReader";

      // liff.scanCode().then(result => {
      //   console.log(result);
      //   // result = { value: '' }
      // });
    })
    
    console.log(params);
    if (params['username']) {
      getCollectProfileByUsername(params['username']);
      $("#mobile-input").val(params['username']);
    }
    // main liff id
    liff.init({ liffId: "1655196636-nvdWB6xz" }, () => {
      if (liff.isLoggedIn()) {
        getLineProfile();
      } else {
        if (liff.isInClient())
          getLineProfile();
        else
          liff.login();
      }
    }, err => console.log(err.code + " : " + err.message));


    // var config = {
    //   databaseURL: `https://pea-datalab.firebaseio.com`,
    //   storageBucket: `pea-datalab.appspot.com`
    // };
    // firebase.initializeApp(config);

    // $(".logout").on("click", function(e) {
    //     e.preventDefault();
    //     liff.logout();
    // });

    $("#mobile-input").change(function() {
      getCollectProfileByUsername($(this).val())
    });

    $(".view-my-task").on("click", function(e) {
      e.preventDefault();
      liff.openWindow({
        url: 'https://line-collect.web.app/?username=' + $("#employee-username-input").val(),
        external: false
      });
    });
    $(".update-profile").on("click", function(e) {
      e.preventDefault();
      myRole = $('[name="role"]:checked').val();

      if (!lineProfile)
        lineProfile = {
          userId: "U00000000000000000000000000000000",
          pictureUrl: "https://line-collect.web.app/img/avatar.png"
        }
      lineCollectProfile = {
        "role": myRole,
        "full_name": $("#full-name-input").val(),
        "username": $("#username-input").val(),
        "email": $("#email-input").val(),
        "title": $("#title-input").val(),
        "line_id": lineProfile.userId,
        "line_access_token": $("#access-token-input").val(),
        "avatar": lineProfile.pictureUrl,
        // "line_profile": lineProfile,
        // "pea_profile": peaProfile
      };
      console.log(lineCollectProfile);
      Disk.set("line_collect_profile", lineCollectProfile);
      let url = "https://asia-east2-line-collect.cloudfunctions.net/users/profile/create";
      axios({
          method: 'post',
          url: url,
          data: lineCollectProfile,
          cache: 'no-cache',
          credentials: 'same-origin',
        })
        .then((response) => {
          alert("บันทึกข้อมูล LINE Collect แล้ว");
          $(".update-profile").hide();

          username = $("#employee-username-input").val();
          window.open('', '_self').close();

          if (liff.isInClient()) 
            //{
            liff.closeWindow();
          // } else {
          //   window.location.href = `https://line-collect.web.app/organize.html?username=${username}`;
          // }

          localStorage.clear();
        })
        .catch((error) => {
          console.log(error);
        });
    });
  })

  function getCollectProfileByUsername(username) {
    if (username == "")
      username = "0826539264";
    url = "https://asia-east2-line-collect.cloudfunctions.net/users/profile/" + username;
    axios({
        method: 'get',
        url: url,
        cache: 'no-cache',
        credentials: 'same-origin',
      })
      .then((response) => {
        console.log(response.data);
        user = response.data[0];

        $("#full-name-input").val(user.full_name);
        $("#email-input").val(user.email);
        $("#mobile-input").val(user.username);
        $("#title-input").val(user.title);
        $("#company-input").val(user.company);

        collect_url += user.username;
        console.log(collect_url)
        genQR(url);

        $(".full-name").html(user.full_name);
        $(".email").html(user.email);
        $(".title").html(user.title);
        $(".company").html(user.company);
        $(".avatar").attr("src",user.avatar);
      })
      .catch((error) => {
        console.log(error);
      });
  }

  function getCollectProfile(myLineID) {
    if (myLineID == "")
      myLineID = "Uda2f7d5dcf8f763f369b557ecab2c9df";
    url = "https://asia-east2-line-collect.cloudfunctions.net/users/profile/line/" + myLineID;
    axios({
        method: 'get',
        url: url,
        cache: 'no-cache',
        credentials: 'same-origin',
      })
      .then((response) => {
        console.log(response.data);
        user = response.data[0];

        $("#full-name-input").val(user.full_name);
        $("#email-input").val(user.email);
        $("#mobile-input").val(user.username);
        $("#title-input").val(user.title);
        $("#company-input").val(user.company);

        collect_url += user.username;
        genQR(url);

        $(".full-name").html(user.full_name);
        $(".email").html(user.email);
        $(".title").html(user.title);
        $(".company").html(user.company);
        $(".avatar").attr("src",user.avatar);

      })
      .catch((error) => {
        console.log(error);
      });
  }

  function genQR(url){
    var qr = kjua({
      render: 'svg',
      //mode:1,
      // left: 30,
      //  top: 30,
      background: "#fff",
      ecLevel: 'L',
      size: 200,
      quiet: 3,
      text: url,
      label: "c0826539264",
      fontname: 'Helvetica',
      fontcolor: '#000',
      mode: 'plain'
      //mode: 'image',
      //image: $(".img-buffer").html()

      // mSize: 0.2,
      // mPosX: 0.5,
      // mPosY: 0.5,

    });
    $("#qrcode").append(qr);
  }

  function getLineProfile() {
    return liff.getProfile().then(function(profile) {
      myLineName = profile.displayName;
      myLineID = profile.userId;

      lineProfile = profile;

      Disk.set("line_profile", profile);
      $("#pictureUrl").attr("src", lineProfile.pictureUrl);
      $("#user-id-input").val(myLineID);
      $("#access-token-input").val(liff.getAccessToken());
      getCollectProfile(myLineID);
    }).catch(function(error) {
      alert(error);
    });
  }

  function logout() {
    if (liff.isLoggedIn()) {
      liff.logout();
      liff.closeWindow();
    }
  }
  </script>
</body>

</html>