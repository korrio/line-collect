<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LINE Collect :: Landing Page</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/css/bootstrap.min.css" />
  <script>
    var regex = /[?&]([^=#]+)=([^&#]*)/g,
        url = window.location.href,
        params = {},
        match;
    while(match = regex.exec(url)) {
        params[match[1]] = match[2];
    }
  </script>
</head>

<body>
  <div class="container">
    <div class="row">
      <div class="col-md-4 mx-auto">
        <div class="card">
          <div class="card-body">
            <div class="profile-image mx-auto">
              <img id="pictureUrl" class="circle img-fluid">
            </div>
            <h2 id="displayName" class="text-center"></h2>
            <form>
              <h2>อัพเดทข้อมูลส่วนตัว</h2>
              <div class="form-group">
                <label for="user-id-input">LINE ID</label>
                <input type="text" class="form-control" id="user-id-input" placeholder="UID" disabled>
              </div>
              <div class="form-group">
                <label for="access-token-input">LINE ACCESS TOKEN</label>
                <input type="text" class="form-control" id="access-token-input" placeholder="UID">
              </div>
              <div class="form-group">
                <label for="first-name-input">ชื่อ</label>
                <input type="text" class="form-control" id="first-name-input" placeholder="First Name">
              </div>
              <div class="form-group">
                <label for="last-name-input">นามสกุล</label>
                <input type="text" class="form-control" id="last-name-input" placeholder="Last Name">
              </div>
              <div class="form-group">
                <label for="email-input">อีเมล์</label>
                <input type="email" class="form-control" id="email-input" aria-describedby="emailHelp">
              </div>
              <div class="form-group">
                <label for="title-input">ตำแหน่ง</label>
                <input type="text" class="form-control" id="title-input" />
              </div>
              <div class="form-group">
                <label for="department-input">สังกัด</label>
                <input type="text" class="form-control" id="department-input" />
              </div>
              <div class="form-group">
                <label for="role">ตำแหน่งในระบบ</label>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="role" id="role1" value="role1" checked>
                  <label class="form-check-label" for="role1">
                    Admin
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="role" id="role2" value="role2">
                  <label class="form-check-label" for="role2">
                    User
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="role" id="role3" value="role3">
                  <label class="form-check-label" for="role3">
                    Judges
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="role" id="role4" value="role4">
                  <label class="form-check-label" for="role4">
                    C-Level
                  </label>
                </div>
              </div>
              <p id="getDecodedIDToken"></p>
              <p>
                <button type="submit" class="btn btn-primary btn-lg btn-block update-profile">
                  อัพเดทข้อมูล
                </button>
              </p>
              <p>
                <button type="button" class="btn btn-success btn-lg btn-block view-my-task">
                  รายชื่อ
                </button>
              </p>
              <p>
                <button type="button" class="btn btn-primary btn-lg btn-block logout">
                  ออกจากระบบ
                </button>
              </p>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
  <script src="https://wechatfe.github.io/vconsole/lib/vconsole.min.js?v=3.3.0"></script>
  <script>
  // init vConsole
  var vConsole = new VConsole();
  console.log('Hello world');
  </script>
  <script>
  let Disk = {

    version: '0.0.1',

    get: (key, default_value = null) => {
      let val = localStorage.getItem(key);
      if (!val) return default_value;
      return JSON.parse(val);
    },

    set: (key, value) => {
      let json_str = JSON.stringify(value);
      localStorage.setItem(key, json_str);
      return value;
    }

  };
  </script>
  <script>
  let lineProfile;
  let peaProfile;
  let rc2Profile;

  let myLineName = "";
  let myLineID = "";
  let myRole = "";

  lineProfile = Disk.get("line_profile");
  peaProfile = Disk.get("pea_profile");
  rc2Profile = Disk.get("rc2_profile");

  if (typeof(rc2Profile) !== 'undefined' && rc2Profile) {
    myRole = rc2Profile.role;
    $('#' + myRole).prop('checked', true);
  }

  if (typeof(peaProfile) !== 'undefined' && peaProfile) {
    $("#first-name-input").val(peaProfile.FirstName[0]);
    $("#last-name-input").val(peaProfile.LastName[0]);
    $("#email-input").val(peaProfile.Email[0]);
    $("#department-input").val(peaProfile.DepartmentShortName[0]);
    $("#employee-id-input").val(peaProfile.EmployeeId[0]);
    $("#employee-username-input").val(peaProfile.Username[0]);
  }

  $(() => {
    console.log(params);
    if (params['username']) {
      getPeaProfile(params['username']);
      $("#employee-username-input").val(params['username']);
    }
    // main liff id
    liff.init({ liffId: "1655196636-nvdWB6xz" }, () => {
      if (liff.isLoggedIn()) {
        getLineProfile();
      } else {
        if (liff.isInClient())
          getLineProfile();
        else
          liff.login();
      }
    }, err => console.log(err.code + " : " + err.message));


    // var config = {
    //   databaseURL: `https://pea-datalab.firebaseio.com`,
    //   storageBucket: `pea-datalab.appspot.com`
    // };
    // firebase.initializeApp(config);

    // $(".logout").on("click", function(e) {
    //     e.preventDefault();
    //     liff.logout();
    // });

    $("#employee-username-input").change(function() {
      console.log($(this).val())
      if ($(this).val().length == 6) {
        getPeaProfile($(this).val())
      }
    });

    $(".view-my-task").on("click", function(e) {
      e.preventDefault();
      liff.openWindow({
        url: 'https://line-collect.web.app/?username=' + $("#employee-username-input").val(),
        external: false
      });
    });
    $(".update-profile").on("click", function(e) {
      e.preventDefault();
      myRole = $('[name="role"]:checked').val();

      if (!lineProfile)
        lineProfile = {
          userId: "U00000000000000000000000000000000",
          pictureUrl: "https://rc2.aq1.co/admin/avatar.png"
        }
      rc2Profile = {
        "role": myRole,
        "first_name": $("#first-name-input").val(),
        "last_name": $("#last-name-input").val(),
        "pea_id": $("#employee-username-input").val(),
        "pea_username": $("#employee-username-input").val(),
        "email": $("#email-input").val(),
        "line_id": lineProfile.userId,
        "avatar": lineProfile.pictureUrl,
        "title": $("#title-input").val(),
        "department": $("#department-input").val(),
        "pea_bacode": $("#bacode-input").val(),
        "pea_subregioncode": $("#subregioncode-input").val(),
        "pea_baname": $("#baname-input").val()
        // "line_profile": lineProfile,
        // "pea_profile": peaProfile
      };
      console.log(rc2Profile);
      Disk.set("rc2_profile", rc2Profile);
      let url = "https://rc2-data.aq1.co/pea-datalab/asia-east2/users/profile/create";
      axios({
          method: 'post',
          url: url,
          data: rc2Profile,
          cache: 'no-cache',
          credentials: 'same-origin',
        })
        .then((response) => {
          alert("บันทึกข้อมูล PEA แล้ว");
          $(".update-profile").hide();

          username = $("#employee-username-input").val();
          window.open('', '_self').close();

          if (liff.isInClient()) {
            liff.closeWindow();
          } else {
            window.location.href = `https://line-collect.web.app/organize.html?username=${username}`;
          }

          localStorage.clear();
        })
        .catch((error) => {
          console.log(error);
        });
    });
  })

  function getPeaProfile(peaUsername) {
    url = `https://rc2-data.aq1.co/pea-datalab/asia-east2/users/profile/${peaUsername}/pea`;
    axios({
        method: 'get',
        url: url,
        cache: 'no-cache',
        credentials: 'same-origin',
      })
      .then((response) => {
        peaProfile = response.data;

        let title = response.data.PositionDescShort[0];
        let department = response.data.DepartmentShortName[0];
        let firstname = response.data.FirstName[0];
        let lastname = response.data.LastName[0];
        let email = response.data.Email[0];

        $("#first-name-input").val(peaProfile.FirstName[0]);
        $("#last-name-input").val(peaProfile.LastName[0]);
        $("#email-input").val(peaProfile.Email[0]);
        $("#department-input").val(peaProfile.DepartmentShortName[0]);
        $("#title-input").val(peaProfile.PositionDescShort[0]);

        $("#bacode-input").val(peaProfile.BaCode[0]);
        $("#baname-input").val(peaProfile.BaName[0]);
        $("#subregioncode-input").val(peaProfile.SubRegionCode[0]);

        console.log(response.data);
      })
      .catch((error) => {
        console.log(error);
      });
  }

  function getRc2Profile(myLineID) {
    if (myLineID == "")
      myLineID = "Uda2f7d5dcf8f763f369b557ecab2c9df";
    url = "https://rc2-data.aq1.co/pea-datalab/asia-east2/users/profile/line/" + myLineID;
    axios({
        method: 'get',
        url: url,
        cache: 'no-cache',
        credentials: 'same-origin',
      })
      .then((response) => {
        console.log(response.data);
        user = response.data[0];

        $("#first-name-input").val(user.first_name);
        $("#last-name-input").val(user.last_name);
        $("#email-input").val(user.email);
        $("#title-input").val(user.title);
        $("#department-input").val(user.department);
        $("#employee-username-input").val(user.pea_id);
      })
      .catch((error) => {
        console.log(error);
      });
  }

  function getLineProfile() {
    return liff.getProfile().then(function(profile) {
      myLineName = profile.displayName;
      myLineID = profile.userId;

      lineProfile = profile;

      Disk.set("line_profile", profile);
      $("#pictureUrl").attr("src", lineProfile.pictureUrl);
      $("#user-id-input").val(myLineID);
      $("access-token-input").val(liff.getAccessToken());
      getRc2Profile(myLineID);
    }).catch(function(error) {
      alert(error);
    });
  }

  function logout() {
    if (liff.isLoggedIn()) {
      liff.logout();
      liff.closeWindow();
    }
  }
  </script>
</body>

</html>